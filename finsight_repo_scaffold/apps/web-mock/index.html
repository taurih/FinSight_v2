<!doctype html>
<html lang="et">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FinSight – Responsiivne eelvaade</title>
<style>
  :root{
    --bg:#f8fafc;--card:#fff;--text:#0f172a;--muted:#475569;--border:#e2e8f0;
    --accent:#2563eb;--green:#16a34a;--yellow:#ca8a04;--red:#dc2626
  }
  [data-theme="dark"]{
    --bg:#0b1220;--card:#0f172a;--text:#e5e7eb;--muted:#9ca3af;--border:#1f2937;
    --accent:#22d3ee;--green:#22c55e;--yellow:#eab308;--red:#f43f5e
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .container{max-width:1100px;margin:0 auto;padding:12px}

  /* Päis: soliidne taust (ei kattu allolevaga), kerge vari, lisapadding */
  .top{
    position:sticky;top:0;
    background:var(--card);
    border-bottom:1px solid var(--border);
    box-shadow:0 1px 0 var(--border);
    z-index:8;
    padding-block:8px;
  }

  .row{display:flex;gap:10px;align-items:center}
  .between{justify-content:space-between}.grow{flex:1}

  /* Brändirida + logo (pilt sisaldab teksti) */
  .brand{display:flex;align-items:center;min-width:172px;}
  .logo{width:172px;height:34px;display:block;overflow:hidden}
  .logo-img{width:100%;height:100%;object-fit:contain;display:block}
  [data-theme="dark"] .logo{background:transparent}

  .input,.select{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text)}

  .btn{
    padding:8px 12px;border:1px solid var(--border);border-radius:12px;background:var(--card);
    color:var(--text);cursor:pointer;transition:background .2s,color .2s,border-color .2s,box-shadow .2s
  }
  .btn:hover{background:color-mix(in srgb,var(--accent) 10%, var(--card));}
  .btn.primary{background:linear-gradient(90deg,#2563eb,var(--accent));color:#fff;border:0;font-weight:600}
  [data-theme="dark"] .btn{background:#1f2937;color:#f1f5f9;border-color:#334155;}
  [data-theme="dark"] .btn:hover{background:#273347;}
  #darkBtn{font-weight:600}
  [data-theme="dark"] #darkBtn{background:linear-gradient(90deg,#2563eb,#22d3ee);color:#fff;border:0;box-shadow:0 1px 2px rgba(0,0,0,.25)}

  .grid{display:grid;gap:12px}
  .grid.cols{grid-template-columns:1fr}
  @media(min-width:980px){ .grid.cols{grid-template-columns:2fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .card-h{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .card-b{padding:10px 12px}
  .muted{color:var(--muted)}

  .kpi{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
  @media(min-width:900px){ .kpi{grid-template-columns:repeat(4,1fr)} }
  .kpi .label{font-size:12px;color:var(--muted);line-height:1.2}
  .kpi .value{font-weight:700;font-size:18px;margin-top:4px}
  @media(min-width:900px){ .kpi .value{font-size:20px} }

  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid;font-size:11px}
  .badge.blue{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe}
  .badge.green{background:#ecfdf5;color:#15803d;border-color:#bbf7d0}
  .badge.yellow{background:#fefce8;color:#a16207;border-color:#fde68a}

  .chart{height:240px}
  @media(min-width:980px){.chart{height:320px}}
  svg{width:100%;height:100%}
  .axis text{fill:var(--muted);font-size:12px}
  .axis line{stroke:var(--border)}
  .area{fill:url(#grad);stroke:#2563eb;stroke-width:3}
  .zero{stroke:#94a3b8;stroke-dasharray:4 2}
  [data-theme="dark"] .zero{stroke:#475569}

  .toast{position:fixed;right:14px;bottom:14px;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 12px;box-shadow:0 4px 18px rgba(0,0,0,.15);opacity:0;transform:translateY(8px);transition:.2s}
  .toast.show{opacity:1;transform:translateY(0)}
  .search-wrap{display:none}
  @media(min-width:720px){.search-wrap{display:flex}}
</style>
</head>
<body>
  <header class="top">
    <div class="container row">
      <div class="brand">
        <div class="logo">
          <img src="FinSightlogo.png" alt="FinSight logo" class="logo-img" decoding="async"/>
        </div>
      </div>
      <div class="search-wrap grow"><input class="input" placeholder="Otsi arveid, kliente…"></div>
      <select id="horizon" class="select" style="max-width:140px">
        <option value="30" selected>30 päeva</option><option value="60">60 päeva</option><option value="90">90 päeva</option>
      </select>
      <button id="createBtn" class="btn primary">Loo prognoos</button>
      <button id="darkBtn" class="btn">Tume: Väljas</button>
      <button id="importBtn" class="btn">Impordi andmed</button>
      <button id="exportBtn" class="btn">Ekspordi CSV</button>
      <input id="fileInput" type="file" accept=".json,.csv" style="display:none"/>
    </div>
  </header>

  <main class="container">
    <section class="card" style="background:radial-gradient(80% 100% at 10% 0%, color-mix(in srgb, var(--accent) 12%, transparent), transparent) var(--card);">
      <div class="card-b">
        <div class="row between">
          <h1 style="margin:0;font-size:22px">Ennustav rahavoo analüütika</h1>
          <div class="row" style="gap:6px">
            <span class="badge green">Prognoos aktiivne</span>
            <span class="badge blue">AI nõustaja</span>
            <span class="badge yellow">Beeta</span>
          </div>
        </div>
        <p class="muted" style="margin:8px 0 0">Näe tulevast likviidsust, enneta riske ja tegutse ühe klõpsuga soovituse alusel.</p>
      </div>
    </section>

    <!-- KPI -->
    <section class="kpi" style="margin-top:12px">
      <div class="card"><div class="card-b"><div class="label">Prognoositav madaljääk</div><div id="kpi-low" class="value">–</div></div></div>
      <div class="card"><div class="card-b"><div class="label">Riskantsed arved</div><div id="kpi-risk" class="value">–</div></div></div>
      <div class="card"><div class="card-b"><div class="label">Keskmine laekumisaeg (päeva)</div><div id="kpi-dso" class="value">–</div></div></div>
      <div class="card"><div class="card-b"><div class="label">Säästupotentsiaal</div><div id="kpi-savings" class="value">–</div></div></div>
    </section>

    <section class="grid cols" style="margin-top:12px">
      <div class="card" style="grid-column:span 1">
        <div class="card-h"><div>Rahavoo prognoos</div></div>
        <div class="card-b">
          <div id="chart" class="chart"></div>
          <div id="chart-note" class="muted" style="margin-top:8px;font-size:13px"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-h"><div>Hoiatused ja tegevused</div><span class="badge blue">Automaatselt loodud</span></div>
        <div class="card-b" id="alerts"></div>
      </div>
    </section>

    <section class="card" style="margin:12px 0 24px">
      <div class="card-h"><div>What-IF</div><span class="badge yellow">Sandbox</span></div>
      <div class="card-b">
        <div class="grid" style="grid-template-columns:1fr;gap:12px">
          <div>
            <div class="muted" style="font-size:13px;margin-bottom:6px">Kliendi makseviivitus (päeva)</div>
            <input id="delay" type="range" min="0" max="20" value="0" style="width:100%"/>
            <div class="muted" style="font-size:12px;margin-top:4px"><span id="delay-val">0</span> päeva</div>
          </div>
          <div>
            <div class="muted" style="font-size:13px;margin-bottom:6px">Ettemakse soodustus (%)</div>
            <input id="discount" type="range" min="0" max="10" value="0" style="width:100%"/>
            <div class="muted" style="font-size:12px;margin-top:4px"><span id="discount-val">0</span>%</div>
          </div>
          <div><button id="rerun" class="btn primary" style="width:100%">↻ Käivita uuesti</button></div>
        </div>
        <div class="muted" style="margin-top:10px;font-size:13px">Tulemus: prognoositav madaljääk on <span id="result-low" class="title" style="font-size:14px"></span>.</div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  // ==== util ====
  const $=s=>document.querySelector(s);
  const fmt=n=>n==null||!isFinite(n)?'–':n.toLocaleString("et-EE",{maximumFractionDigits:0});
  const fDate=d=>new Intl.DateTimeFormat('et-EE',{day:'2-digit',month:'long'}).format(d);
  const fDateShort=d=>new Intl.DateTimeFormat('et-EE',{day:'2-digit',month:'2-digit'}).format(d);
  const toast=m=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1500)};

  // --- AJAVAHEMIK (täna ... täna + range päeva)
  function windowBounds(){
    const start = new Date(); start.setHours(0,0,0,0);
    const end = new Date(start); end.setDate(end.getDate() + (Number(range)||30));
    return { start, end };
  }
  function inWindow(dt, start, end){
    const d = new Date(dt); d.setHours(0,0,0,0);
    return (+d) >= (+start) && (+d) <= (+end);
  }

  // ======= DEMO ANDMED =======
  const d=(y,m,day)=>new Date(y,m,day);
  const preset30=[{date:d(2025,7,21),balance:12000},{date:d(2025,7,25),balance:9800},{date:d(2025,7,29),balance:4100},{date:d(2025,8,2),balance:-2000},{date:d(2025,8,6),balance:3600},{date:d(2025,8,10),balance:8200}];
  const preset60=preset30.concat([{date:d(2025,8,14),balance:6200},{date:d(2025,8,20),balance:10400},{date:d(2025,8,28),balance:7300}]);
  const preset90=preset60.concat([{date:d(2025,9,5),balance:9100},{date:d(2025,9,12),balance:6600},{date:d(2025,9,20),balance:11800}]);

  const clients=[
    {name:"Klient A",scale:1.00,offset:0},
    {name:"Klient B",scale:0.65,offset:-400},
    {name:"Klient C",scale:0.40,offset:-900}
  ];

  // ======= STATE =======
  let range=30, clientsState=[];
  let importedRows=null; // imporditud read
  let clientMeta=new Map(); // kliendipõhised metaandmed
  let hasData=false;

  // demo seeriad
  const seriesFor=(r,s,o)=>({30:preset30,60:preset60,90:preset90}[r]).map(p=>({date:new Date(p.date),balance:Math.round(p.balance*s+o)}));
  function rebuild(){ // demo rebuild
    clientsState=clients.map(c=>{
      const base=seriesFor(range,c.scale,c.offset);
      return {name:c.name,baseData:base.map(x=>({...x})),data:base.map(x=>({...x}))}
    });
    // demo meta
    clientMeta = new Map([
      ["Klient A",{due_days:14, usual_payment_days:16, past_issues:0}],
      ["Klient B",{due_days:30, usual_payment_days:37, past_issues:2}],
      ["Klient C",{due_days:21, usual_payment_days:28, past_issues:1}],
    ]);
  }

  // imporditud seeriad
  function rebuildFromImported(rows){
    const byClient = new Map();
    rows.forEach(r=>{
      const dt = new Date(r.date);
      const rec = {date: dt, balance: Number(r.forecast)};
      const base = {date: dt, balance: Number(r.actual ?? r.forecast ?? 0)};
      if(!byClient.has(r.client)) byClient.set(r.client,{name:r.client, baseData:[], data:[]});
      byClient.get(r.client).baseData.push(base);
      byClient.get(r.client).data.push(rec);

      const due_days = num(r.due_days);
      const upd = num(r.usual_payment_days);
      const past = (r.past_issues===true || r.past_issues===false) ? (r.past_issues?1:0) : num(r.past_issues);
      if(Number.isFinite(due_days)||Number.isFinite(upd)||Number.isFinite(past)){
        const prev = clientMeta.get(r.client) || {};
        clientMeta.set(r.client,{
          due_days: Number.isFinite(due_days)?due_days:(prev.due_days ?? null),
          usual_payment_days: Number.isFinite(upd)?upd:(prev.usual_payment_days ?? null),
          past_issues: Number.isFinite(past)?past:(prev.past_issues ?? 0)
        });
      }
    });
    clientsState = [...byClient.values()].map(c=>{
      c.baseData.sort((a,b)=>+a.date-+b.date);
      c.data.sort((a,b)=>+a.date-+b.date);
      return c;
    });
  }

  // agregaadid (valikuline akna filter)
  function aggregate(kind, {windowed=false} = {}){
    const map = new Map();
    const { start, end } = windowBounds();

    clientsState.forEach(c => (kind==='base'?c.baseData:c.data).forEach(p=>{
      if (windowed && !inWindow(p.date, start, end)) return;
      const k = +p.date;
      map.set(k, (map.get(k)||0) + (Number(p.balance)||0));
    }));

    return [...map.entries()].sort((a,b)=>a[0]-b[0]).map(([k,sum])=>({date:new Date(+k),balance:sum}));
  }

  // ======= TUME/HELE =======
  function setTheme(mode){
    document.body.setAttribute('data-theme',mode);
    localStorage.setItem('finsight_theme',mode);
    $("#darkBtn").textContent=`Tume: ${mode==='dark'?'Sees':'Väljas'}`;
    drawChart();
  }
  (function initTheme(){
    const saved=localStorage.getItem('finsight_theme');
    setTheme(saved==='dark'?'dark':'light');
    $("#darkBtn").onclick=()=>setTheme(document.body.getAttribute('data-theme')==='dark'?'light':'dark');
  })();

  // ======= WHAT-IF =======
  const delay=$("#delay"),discount=$("#discount"),delayVal=$("#delay-val"),discountVal=$("#discount-val");
  delay.oninput=()=>delayVal.textContent=delay.value;
  discount.oninput=()=>discountVal.textContent=discount.value;
  $("#rerun").addEventListener('click',simulate);

  function simulate(){
    if(!hasData){ toast("Andmeid pole – loo prognoos või impordi fail"); return; }
    const dly=+delay.value||0, disc=+discount.value||0;
    const factor=1 + Math.min(.5, dly*.05) - Math.min(.3, disc*.03);

    const { start, end } = windowBounds();
    clientsState = clientsState.map(c => ({
      ...c,
      data: c.data.map(pt => {
        const inWin = inWindow(pt.date, start, end);
        const val = Number(pt.balance) || 0;
        return inWin ? { ...pt, balance: Math.round(val * factor) } : { ...pt };
      })
    }));

    refresh();
    toast("Stsenaarium uuendatud");
  }

  // ======= FORECAST (30/60/90) =======
  function initRange(r){
    range=r;
    if(importedRows){ rebuildFromImported(importedRows); } else { rebuild(); }
    hasData = clientsState.some(c=> (c.data?.length||0) > 0);
    refresh();
  }
  document.getElementById('createBtn').onclick=()=>{
    const r=parseInt(document.getElementById('horizon').value,10)||30;
    initRange(r); toast(`Prognoos loodud ${r} päevaks`);
  };

  // ======= IMPORT (CSV/JSON) =======
  document.getElementById('importBtn').onclick=()=>document.getElementById('fileInput').click();
  document.getElementById('fileInput').addEventListener('change', async (e)=>{
    const file=e.target.files?.[0]; if(!file){return;}
    try{
      const text = await file.text();
      let parsed; try { parsed = JSON.parse(text); } catch {}
      let rows;

      // Vorm 1: { rows:[], clientMeta:{} }
      if(parsed && !Array.isArray(parsed) && parsed.rows){
        rows = parsed.rows;
        importedRows = rows;
        clientMeta = new Map();
        if(parsed.clientMeta && typeof parsed.clientMeta === 'object'){
          Object.entries(parsed.clientMeta).forEach(([k,v])=>{
            clientMeta.set(k, {
              due_days: num(v.due_days),
              usual_payment_days: num(v.usual_payment_days),
              past_issues: num(v.past_issues) || 0
            });
          });
        }
      }else{
        // Vorm 2: lamedad read või CSV
        if(Array.isArray(parsed)){ rows = parsed; }
        if(!rows){
          rows = parseCSV(text);
        }
        importedRows = rows;
      }

      rows = rows.map(r=>({
        date: (r.date||r.kuupäev||r.Kuupäev||"").trim(),
        client: (r.client||r.klient||r["Kliendi nimi"]||"").trim(),
        forecast: num(r.forecast ?? r.prognoos ?? r["Prognoositud jääk (€)"]),
        actual: num(r.actual ?? r.tegelik ?? r["Tegelik jääk (€)"]),
        due_days: num(r.due_days ?? r["Maksetähtaeg (p)"]),
        usual_payment_days: num(r.usual_payment_days ?? r["Tüüpiline laekumine (p)"]),
        past_issues: (r.past_issues===true||r.past_issues===false)?(r.past_issues?1:0):num(r.past_issues ?? r["Varasemad probleemid (kordade arv)"])
      })).filter(r=>r.date && r.client && isFinite(r.forecast));

      if(!rows.length){ toast("Failist ei leitud sobivaid ridu"); return; }

      if(!clientMeta || !(clientMeta instanceof Map) || clientMeta.size===0){
        clientMeta = new Map();
      }
      rows.forEach(r=>{
        const prev = clientMeta.get(r.client) || {};
        clientMeta.set(r.client,{
          due_days: Number.isFinite(r.due_days)?r.due_days:(prev.due_days ?? null),
          usual_payment_days: Number.isFinite(r.usual_payment_days)?r.usual_payment_days:(prev.usual_payment_days ?? null),
          past_issues: Number.isFinite(r.past_issues)?r.past_issues:(prev.past_issues ?? 0)
        });
      });

      rebuildFromImported(rows);
      hasData = true;
      refresh();
      toast(`Imporditud ${rows.length} rida`);
    }catch(err){
      try{
        const rows = parseCSV(text).map(r=>({
          date: (r.date||r.kuupäev||r.Kuupäev||"").trim(),
          client: (r.client||r.klient||r["Kliendi nimi"]||"").trim(),
          forecast: num(r.forecast ?? r.prognoos ?? r["Prognoositud jääk (€)"]),
          actual: num(r.actual ?? r.tegelik ?? r["Tegelik jääk (€)"])
        })).filter(r=>r.date && r.client && isFinite(r.forecast));
        if(!rows.length){ throw new Error("No CSV rows"); }
        importedRows = rows;
        rebuildFromImported(rows);
        hasData = true;
        refresh();
        toast(`Imporditud ${rows.length} rida (CSV)`);
      }catch(e2){
        console.error(err); console.error(e2); toast("Impordi viga");
      }
    }finally{
      e.target.value = "";
    }
  });

  function parseCSV(text){
    const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length>0);
    if(!lines.length) return [];
    const sniffSemicolon = lines[0].includes(';');
    const sep = sniffSemicolon ? ';' : ',';
    const headers = lines[0].split(sep).map(h=>h.trim());
    return lines.slice(1).map(line=>{
      const cols = line.split(sep);
      const obj={};
      headers.forEach((h,i)=>obj[h]=cols[i]?.trim());
      return obj;
    });
  }
  const num=v=>v==null||v===''?null:Number(String(v).replace(/\s/g,'').replace(',', '.'));

  // ======= CSV EKSPORT =======
  document.getElementById('exportBtn').onclick=()=>{
    if(!hasData){ toast("Andmeid pole eksportida"); return; }
    const { start, end } = windowBounds();
    const rows=[["Kuupäev","Kliendi nimi","Tegelik jääk (€)","Prognoositud jääk (€)","Märkus"]];
    if(importedRows){
      importedRows.forEach(r=>{
        const dt=new Date(r.date);
        const past = (+dt) < (+start);
        if(!inWindow(dt, start, end) && !past) return;
        rows.push([fDate(dt), r.client || "", r.actual ?? "", r.forecast ?? "", past?"Tegelik":"Prognoos"]);
      });
    }else{
      clientsState.forEach(c=>{
        (c.data||[]).forEach(pt=>{
          const dt=new Date(pt.date);
          const past=(+dt)<(+start);
          if(!inWindow(dt, start, end) && !past) return;
          const base = (c.baseData.find(x=>+x.date==+pt.date)||{}).balance;
          rows.push([fDate(pt.date), c.name, past?fmt(base):"", (pt.balance!=null?String(pt.balance):""), past?"Tegelik":"Prognoos"]);
        });
      });
    }
    const csv=rows.map(cols=>cols.map(c=>{const s=String(c);return /[;"\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s}).join(";")).join("\n");
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8"}));
    a.download=`finsight_${new Date().toISOString().slice(0,10)}_${range}p.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    toast("CSV eksporditud");
  };

  // ======= KPI arvutused (horisondis) =======
  function computeKPIs(){
    if(!hasData) return {low:null,risk:null,dso:null,savings:null};

    const s = aggregate('forecast', { windowed:true });
    const low = s.length ? s.reduce((m,p)=>Math.min(m, Number(p.balance)||0), Infinity) : null;

    // Risk (negatiivsed horisondis)
    let risk = null;
    const { start, end } = windowBounds();
    if(importedRows){
      risk = importedRows.filter(r=>{
        const f = Number(r.forecast)||0;
        return f < 0 && inWindow(r.date, start, end);
      }).length;
    }else{
      let cnt=0;
      clientsState.forEach(c=>{
        c.data.forEach(pt=>{
          const v = Number(pt.balance)||0;
          if (v<0 && inWindow(pt.date, start, end)) cnt++;
        });
      });
      risk = cnt;
    }

    // DSO: meta keskmine; varuvariant mineviku delta'dest
    let dso = null;
    const metas = clientsState
      .map(c => (clientMeta.get(c.name)||{}).usual_payment_days)
      .filter(v => Number.isFinite(v));
    if (metas.length){
      dso = Math.round(metas.reduce((a,b)=>a+b,0)/metas.length);
    } else if (importedRows) {
      const byClient = new Map();
      importedRows.forEach(r=>{
        const dt = new Date(r.date);
        const rec = {date: dt, forecast: Number(r.forecast), actual: (r.actual==null?null:Number(r.actual)), client:r.client};
        if(!byClient.has(r.client)) byClient.set(r.client,[]);
        byClient.get(r.client).push(rec);
      });
      const deltas=[];
      byClient.forEach(list=>{
        list.sort((a,b)=>+a.date-+b.date);
        const today0 = new Date(); today0.setHours(0,0,0,0);
        const past = list.filter(x => (+x.date) < (+today0));
        const firstForecast = past.find(x => Number.isFinite(x.forecast));
        const firstActual = past.find(x => Number.isFinite(x.actual) && (!firstForecast || +x.date >= +firstForecast.date));
        if(firstForecast && firstActual){
          const diffDays = Math.round((+firstActual.date - +firstForecast.date)/(1000*60*60*24));
          if(diffDays>=0 && Number.isFinite(diffDays)) deltas.push(diffDays);
        }
      });
      if(deltas.length) dso = Math.round(deltas.reduce((a,b)=>a+b,0)/deltas.length);
    }

    // Sääst (2% negatiivsete summast horisondis)
    let savings = null;
    if(importedRows){
      const sumNeg = importedRows.reduce((acc,r)=>{
        const f = Number(r.forecast)||0;
        return acc + ((f<0 && inWindow(r.date, start, end)) ? Math.abs(f) : 0);
      },0);
      savings = sumNeg * 0.02;
    }else{
      let sumNeg = 0;
      clientsState.forEach(c=>{
        c.data.forEach(pt=>{
          const v = Number(pt.balance)||0;
          if (v<0 && inWindow(pt.date, start, end)) sumNeg += Math.abs(v);
        });
      });
      savings = sumNeg * 0.02;
    }

    return {low, risk, dso, savings};
  }

  // ======= HOIATUSTE TUVASTUS (kliendipõhine, horisondis) =======
  function detectAlerts(){
    if(!hasData) return [];
    const { start, end } = windowBounds();

    const alertsByClient = [];

    clientsState.forEach(c=>{
      const meta = clientMeta.get(c.name) || {};
      const due = meta.due_days ?? null;
      const usual = meta.usual_payment_days ?? null;
      const issues = meta.past_issues ?? 0;

    const neg = (c.data||[]).filter(p=>{
        const v = Number(p.balance)||0;
        return v < 0 && inWindow(p.date, start, end);
      });

      if(!neg.length) return;

      const firstNeg = neg.reduce((m,p)=> (p.date < m.date ? p : m), neg[0]);
      const days = Math.max(0, Math.round((+firstNeg.date - +start)/(1000*60*60*24)));
      const type = days<=3 ? "critical" : (days<=10 ? "warn" : "info");

      const metaBits = [];
      if(Number.isFinite(due)) metaBits.push(`maksetähtaeg ~${due} p`);
      if(Number.isFinite(usual)) metaBits.push(`tüüpiline laekumine ~${usual} p`);
      if(Number.isFinite(issues) && issues>0) metaBits.push(`varasemaid probleeme: ${issues}×`);

      alertsByClient.push({
        client: c.name,
        type,
        title: `Negatiivne jääk ${days ? (days + " päeva pärast") : "täna"}`,
        detail: `Esimene negatiivne punkt ${fDate(firstNeg.date)} (${fmt(firstNeg.balance)} €).${metaBits.length? " ("+metaBits.join(", ")+")":""}`
      });
    });

    // Üldine portfellihäire horisondis
    const s = aggregate('forecast', { windowed:true });
    const futureNegAgg = s.filter(p=> (Number(p.balance)||0) < 0 );
    if(futureNegAgg.length){
      const minPt = futureNegAgg.reduce((m,p)=> (p.balance < m.balance ? p : m), futureNegAgg[0]);
      const daysAgg = Math.max(0, Math.round((+minPt.date - +start)/(1000*60*60*24)));
      alertsByClient.unshift({
        client: null,
        type: daysAgg<=3 ? "critical" : "warn",
        title:`Likviidsusauk portfellis ${daysAgg ? (daysAgg+" päeva pärast") : "täna"}`,
        detail:`Minimaalseks prognoositakse ${fmt(minPt.balance)} € (${fDate(minPt.date)}).`
      });
    }

    return alertsByClient;
  }

  // ======= RENDERDUS =======
  function renderAlerts(items){
    const el=$("#alerts");
    el.innerHTML="";
    if(!items || !items.length) return;

    const general = items.filter(a=>!a.client);
    const byClient = items.filter(a=>a.client);

    const paintCard = (a)=>{
      const tone = a.type==="critical" ? "var(--red)" : (a.type==="warn" ? "var(--yellow)" : "var(--green)");
      const card=document.createElement('div');
      card.style.cssText=`border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px;background:color-mix(in srgb, ${tone} 14%, var(--card));`;
      const head = a.client ? `<div style="font-size:12px;color:var(--muted);margin-bottom:4px">${a.client}</div>` : "";
      card.innerHTML = `${head}<div style="font-weight:600">${a.title}</div><div class="muted" style="font-size:13px">${a.detail}</div>`;
      return card;
    };

    general.forEach(a=>el.appendChild(paintCard(a)));
    byClient.forEach(a=>el.appendChild(paintCard(a)));
  }

  // ======= PADIMINE GRAAFIKU JAOKS =======
  function padSeries(s, start, end){
    if(!s || !s.length) return s;
    const out = [...s];
    const first = s[0], last = s[s.length-1];
    if(+first.date > +start){
      out.unshift({date:new Date(start), balance:first.balance});
    }
    if(+last.date < +end){
      out.push({date:new Date(end), balance:last.balance});
    }
    return out;
  }

  // ======= GRAAFIK (horisondis, pad'iga) =======
  function drawChart(){
    const el = document.getElementById("chart");
    el.innerHTML = "";
    if(!hasData){
      document.getElementById('chart-note').textContent = "";
      return;
    }

    const { start, end } = windowBounds();
    let s = aggregate('forecast', { windowed:true });
    s = padSeries(s, start, end); // lisa sentinaalid

    const w = el.clientWidth || 600, h = el.clientHeight || 240, p = {l:46,r:10,t:10,b:28};
    const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("viewBox",`0 0 ${w} ${h}`); el.appendChild(svg);

    const defs=document.createElementNS(svg.namespaceURI,"defs");
    const grad=document.createElementNS(svg.namespaceURI,"linearGradient");
    grad.setAttribute("id","grad"); grad.setAttribute("x1","0"); grad.setAttribute("y1","0"); grad.setAttribute("x2","0"); grad.setAttribute("y2","1");
    const g1=document.createElementNS(svg.namespaceURI,"stop"); g1.setAttribute("offset","0%"); g1.setAttribute("stop-color","#2563eb"); g1.setAttribute("stop-opacity","0.30");
    const g2=document.createElementNS(svg.namespaceURI,"stop"); g2.setAttribute("offset","100%"); g2.setAttribute("stop-color","#2563eb"); g2.setAttribute("stop-opacity","0.02");
    grad.appendChild(g1); grad.appendChild(g2); defs.appendChild(grad); svg.appendChild(defs);

    const xs = s.map(d => fDateShort(d.date));
    const ys = s.map(d => Number(d.balance)||0);
    if (xs.length === 0){ document.getElementById('chart-note').textContent = "Valitud aknas andmeid ei ole."; return; }

    const xspan = Math.max(1, (xs.length - 1));
    const xstep = (w - p.l - p.r) / xspan;
    const ymin = Math.min(0, ...ys), ymax = Math.max(...ys), yspan = Math.max(1, ymax - ymin);
    const X = i => p.l + i * xstep;
    const Y = v => p.t + (h - p.t - p.b) * (1 - (v - ymin) / yspan);

    const minLabelSpacing = 46;
    const maxLabels = Math.max(2, Math.floor((w - p.l - p.r) / minLabelSpacing));
    const labelStep = Math.max(1, Math.ceil(xs.length / maxLabels));

    const axis = document.createElementNS(svg.namespaceURI,"g"); axis.setAttribute("class","axis");
    xs.forEach((lbl, i) => {
      const tx = X(i);
      const tick = document.createElementNS(svg.namespaceURI,"line");
      tick.setAttribute("x1", tx); tick.setAttribute("x2", tx);
      tick.setAttribute("y1", p.t); tick.setAttribute("y2", h - p.b);
      tick.setAttribute("stroke", "var(--border)");
      tick.setAttribute("stroke-dasharray", "3 3");
      axis.appendChild(tick);

      if (i % labelStep === 0) {
        const t = document.createElementNS(svg.namespaceURI,"text");
        t.setAttribute("x", tx); t.setAttribute("y", h - 6);
        t.setAttribute("text-anchor", "middle");
        t.textContent = lbl;
        axis.appendChild(t);
      }
    });

    for (let i = 0; i <= 4; i++) {
      const v = ymin + (yspan / 4) * i, ty = Y(v);
      const line = document.createElementNS(svg.namespaceURI,"line");
      line.setAttribute("x1", p.l); line.setAttribute("x2", w - p.r);
      line.setAttribute("y1", ty);  line.setAttribute("y2", ty);
      line.setAttribute("stroke", "var(--border)");
      line.setAttribute("stroke-dasharray", "3 3");
      axis.appendChild(line);

      const lab = document.createElementNS(svg.namespaceURI,"text");
      lab.setAttribute("x", p.l - 8); lab.setAttribute("y", ty + 4);
      lab.setAttribute("text-anchor", "end");
      lab.textContent = fmt(v);
      axis.appendChild(lab);
    }
    svg.appendChild(axis);

    let dpath = "";
    s.forEach((pt, i) => { const px = X(i), py = Y(Number(pt.balance)||0); dpath += (i===0 ? `M ${px} ${py}` : ` L ${px} ${py}`); });
    const y0 = Y(0);
    if (xs.length > 0) dpath += ` L ${X(xs.length-1)} ${y0} L ${X(0)} ${y0} Z`;
    const area = document.createElementNS(svg.namespaceURI,"path");
    area.setAttribute("d", dpath); area.setAttribute("class", "area");
    svg.appendChild(area);

    const zero = document.createElementNS(svg.namespaceURI,"line");
    zero.setAttribute("x1", p.l); zero.setAttribute("x2", w - p.r);
    zero.setAttribute("y1", y0);  zero.setAttribute("y2", y0);
    zero.setAttribute("class", "zero");
    svg.appendChild(zero);
  }

  function refresh(){
    const {low, risk, dso, savings} = computeKPIs();

    // What-IF väljund
    const res = document.getElementById('result-low');
    if (res) res.textContent = (low==null ? "–" : `${fmt(low)} €`);

    $("#kpi-low").textContent = low==null? "–" : `${fmt(low)} €`;
    $("#kpi-risk").textContent = risk==null? "–" : String(risk);
    $("#kpi-dso").textContent = dso==null? "–" : `${dso} p`;
    $("#kpi-savings").textContent = savings==null? "–" : `${fmt(Math.round(savings))} €`;

    if(!hasData){
      $("#chart").innerHTML = "";
      $("#chart-note").textContent = "";
      renderAlerts([]);
      return;
    }

    $("#chart-note").innerHTML=(low!=null && low<0)
      ? `Prognoos näitab <span style="color:var(--red);font-weight:600">likviidsusauku ${fmt(low)} €</span>.`
      : `<span style="color:var(--green);font-weight:600">Likviidsusauku ei tuvastatud</span>.`;

    drawChart();

    const alerts = detectAlerts();
    renderAlerts(alerts);
  }

  // ======= INIT (tühi algseis) =======
  (function init(){
    hasData = false;
    clientsState = [];
    importedRows = null;
    clientMeta = new Map();
    refresh();

    document.getElementById('createBtn').onclick=()=>{
      const r=parseInt(document.getElementById('horizon').value,10)||30;
      initRange(r); toast(`Prognoos loodud ${r} päevaks`);
    };

    // What-If UI live väärtused
    const delay=$("#delay"),discount=$("#discount"),delayVal=$("#delay-val"),discountVal=$("#discount-val");
    if(delay && delayVal) delay.oninput=()=>delayVal.textContent=delay.value;
    if(discount && discountVal) discount.oninput=()=>discountVal.textContent=discount.value;
  })();

  window.addEventListener('resize',()=>{ if(hasData) drawChart(); });
</script>
</body>
</html>
