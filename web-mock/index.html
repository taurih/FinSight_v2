<!doctype html>
<html lang="et">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FinSight – Demo (päris andmete tugi)</title>
<style>
  :root{
    --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569; --border:#e2e8f0; --accent:#2563eb;
    --btn-bg:#ffffff; --btn-text:#0f172a; --btn-border:#e2e8f0; --btn-grad1:#2563eb; --btn-grad2:#06b6d4;
    --green:#16a34a; --yellow:#ca8a04; --red:#dc2626;
  }
  [data-theme="dark"]{
    --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937; --accent:#22d3ee;
    --btn-bg:#0f172a; --btn-text:#e5e7eb; --btn-border:#1f2937; --btn-grad1:#0ea5e9; --btn-grad2:#14b8a6;
    --green:#22c55e; --yellow:#eab308; --red:#f43f5e;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .container{max-width:1100px;margin:0 auto;padding:12px}
  .top{position:sticky;top:0;background:color-mix(in srgb,var(--card) 92%,transparent);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:8}
  .row{display:flex;gap:12px;align-items:center}.between{justify-content:space-between}.grow{flex:1}
  .brand{display:flex;gap:8px;align-items:center;font-weight:600}
  .logo{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--btn-grad1),var(--btn-grad2));color:#fff;display:grid;place-items:center}
  .input,.select{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text)}
  .btn{padding:8px 12px;border:1px solid var(--btn-border);border-radius:12px;background:var(--btn-bg);color:var(--btn-text);cursor:pointer;transition:transform .04s ease, box-shadow .15s ease}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(90deg,var(--btn-grad1),var(--btn-grad2));color:#fff;border:0;font-weight:600;box-shadow:0 4px 12px rgba(2,132,199,.25)}
  .btn.ghost{background:var(--btn-bg)}
  .grid{display:grid;gap:14px}
  .grid.cols{grid-template-columns:1fr}
  @media(min-width:980px){ .grid.cols{grid-template-columns:2fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .card-h{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .card-b{padding:12px}
  .muted{color:var(--muted)}
  .kpi{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  @media(min-width:760px){ .kpi{grid-template-columns:repeat(4,1fr)}}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid;font-size:11px}
  .badge.blue{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe}
  .badge.green{background:#ecfdf5;color:#15803d;border-color:#bbf7d0}
  .badge.yellow{background:#fefce8;color:#a16207;border-color:#fde68a}
  .chart{height:240px}@media(min-width:980px){.chart{height:320px}}
  svg{width:100%;height:100%}.axis text{fill:var(--muted);font-size:12px}.axis line{stroke:var(--border)}
  .area{fill:url(#grad);stroke:var(--accent);stroke-width:3}.zero{stroke:#94a3b8;stroke-dasharray:4 2}[data-theme="dark"] .zero{stroke:#475569}
  .toast{position:fixed;right:14px;bottom:14px;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 12px;box-shadow:0 4px 18px rgba(0,0,0,.15);opacity:0;transform:translateY(8px);transition:.2s}
  .toast.show{opacity:1;transform:translateY(0)}
  .search-wrap{display:none}@media(min-width:720px){.search-wrap{display:flex}}
</style>
</head>
<body>
  <header class="top">
    <div class="container row">
      <div class="brand"><div class="logo">F</div> FinSight</div>
      <div class="search-wrap grow"><input class="input" placeholder="Otsi arveid, kliente…"></div>
      <select id="horizon" class="select" style="max-width:140px">
        <option value="30">30 päeva</option><option value="60">60 päeva</option><option value="90">90 päeva</option>
      </select>
      <button id="createBtn" class="btn primary">Loo prognoos</button>
      <button id="darkBtn" class="btn ghost">Tume: Väljas</button>
      <button id="exportBtn" class="btn ghost">Ekspordi CSV</button>
    </div>
  </header>

  <main class="container">
    <section class="card" style="background:radial-gradient(80% 100% at 10% 0%, color-mix(in srgb, var(--accent) 12%, transparent), transparent) var(--card);">
      <div class="card-b">
        <div class="row between">
          <h1 style="margin:0;font-size:22px">Ennustav rahavoo analüütika</h1>
          <div class="row" style="gap:6px"><span class="badge green">Prognoos aktiivne</span><span class="badge blue">AI nõustaja</span><span class="badge yellow">Beeta</span></div>
        </div>
        <p class="muted" style="margin:8px 0 0">Näe tulevast likviidsust, enneta riske ja tegutse ühe klõpsuga soovituse alusel.</p>
      </div>
    </section>

    <section class="kpi" style="margin-top:12px">
      <div class="card"><div class="card-b"><div class="muted">Prognoositav madaljääk</div><div id="kpi-low" class="title" style="font-weight:600;font-size:20px">–</div></div></div>
      <div class="card"><div class="card-b"><div class="muted">Riskantsed arved</div><div id="kpi-risk" class="title" style="font-weight:600;font-size:20px">–</div></div></div>
      <div class="card"><div class="card-b"><div class="muted">Keskmine laekumisaeg</div><div id="kpi-dso" class="title" style="font-weight:600;font-size:20px">–</div></div></div>
      <div class="card"><div class="card-b"><div class="muted">Säästupotentsiaal</div><div id="kpi-savings" class="title" style="font-weight:600;font-size:20px">–</div></div></div>
    </section>

    <section class="grid cols" style="margin-top:12px">
      <div class="card" style="grid-column:span 1">
        <div class="card-h"><div>Rahavoo prognoos</div></div>
        <div class="card-b">
          <div id="chart" class="chart"></div>
          <div id="chart-note" class="muted" style="margin-top:8px;font-size:13px"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-h"><div>Hoiatused ja tegevused</div><span class="badge blue">Automaatselt loodud</span></div>
        <div class="card-b" id="alerts"></div>
      </div>
    </section>

    <section class="card" style="margin:12px 0 24px">
      <div class="card-h"><div>What-IF</div><span class="badge yellow">Sandbox</span></div>
      <div class="card-b">
        <div class="grid" style="grid-template-columns:1fr;gap:12px">
          <div>
            <div class="muted" style="font-size:13px;margin-bottom:6px">Kliendi makseviivitus (päeva)</div>
            <input id="delay" type="range" min="0" max="20" value="0" style="width:100%"/>
            <div class="muted" style="font-size:12px;margin-top:4px"><span id="delay-val">0</span> päeva</div>
          </div>
          <div>
            <div class="muted" style="font-size:13px;margin-bottom:6px">Ettemakse soodustus (%)</div>
            <input id="discount" type="range" min="0" max="10" value="0" style="width:100%"/>
            <div class="muted" style="font-size:12px;margin-top:4px"><span id="discount-val">0</span>%</div>
          </div>
          <div><button id="rerun" class="btn primary" style="width:100%">↻ Käivita uuesti</button></div>
        </div>
        <div class="muted" style="margin-top:10px;font-size:13px">Tulemus: prognoositav madaljääk on <span id="result-low" class="title" style="font-size:14px"></span>.</div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  // ==== util ====
  const $=s=>document.querySelector(s);
  const fmt=n=>n.toLocaleString("et-EE",{maximumFractionDigits:0});
  const fDDMM=d=>{const dd=String(d.getDate()).padStart(2,'0');const mm=String(d.getMonth()+1).padStart(2,'0');return `${dd}.${mm}`};
  const daysBetween=(a,b)=>Math.round((b-a)/(1000*60*60*24));
  const toast=m=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1500)};

  // ==== teema ====
  function setTheme(m){
    document.body.setAttribute('data-theme',m);
    localStorage.setItem('finsight_theme',m);
    $("#darkBtn").textContent = `Tume: ${m==='dark'?'Sees':'Väljas'}`;
    drawChart();
  }
  setTheme(localStorage.getItem('finsight_theme')==='dark'?'dark':'light');
  $("#darkBtn").onclick=()=>setTheme(document.body.getAttribute('data-theme')==='dark'?'light':'dark');

  // ==== seisund ====
  let range=30;
  let raw={};           // demo.json sisu
  let events=[];        // {date: Date, amount: number, client?: string, note?: string, actual?:boolean}
  let invoices=[];      // {issueDate,dueDate,paidDate?,amount,client}
  let series=[];        // agregeeritud kumulatiivne seeria
  let visible=[];       // seeria lõigatud vastavalt range'ile

  // ==== andmete laadimine ====
  async function loadData(){
    try{
      const r = await fetch('demo.json',{cache:'no-store'});
      if(!r.ok) throw new Error('demo.json puudub või ei loe');
      raw = await r.json();
    }catch(e){
      // varuandmed, kui demo.json puudub
      raw = {
        startingBalance: 5000,
        // Cash-sündmused: positiivne = laekumine, negatiivne = väljaminek
        cashEvents: [
          { date:"2025-08-21", amount: 3000, client:"Klient A", actual:true },
          { date:"2025-08-25", amount:-4200, client:"Tarnija Z", actual:true },
          { date:"2025-08-29", amount: 1300, client:"Klient B", actual:true },
          { date:"2025-09-02", amount:-5000, client:"Tarnija Z", actual:false },
          { date:"2025-09-06", amount: 5600, client:"Klient C", actual:false },
          { date:"2025-09-10", amount: 2400, client:"Klient A", actual:false }
        ],
        // Arved DSO jaoks (lihtsustatud)
        invoices: [
          { issueDate:"2025-08-01", dueDate:"2025-08-14", paidDate:"2025-08-12", amount:1800, client:"Klient A" },
          { issueDate:"2025-08-10", dueDate:"2025-08-24", paidDate:"2025-09-01", amount:2400, client:"Klient B" },
          { issueDate:"2025-08-22", dueDate:"2025-09-05",                 amount:2600, client:"Klient C" } // maksmata
        ]
      };
    }
  }

  function toDate(s){ const d = new Date(s); d.setHours(0,0,0,0); return d; }

  // Koosta sündmused
  function buildEventsFromRaw(){
    events = [];
    invoices = Array.isArray(raw.invoices)? raw.invoices.map(v=>({
      issueDate: v.issueDate?toDate(v.issueDate):null,
      dueDate:   v.dueDate?toDate(v.dueDate):null,
      paidDate:  v.paidDate?toDate(v.paidDate):null,
      amount:    Number(v.amount||0),
      client:    v.client||"—"
    })) : [];

    // 1) Kui cashEvents olemas, kasuta neid otseselt
    if(Array.isArray(raw.cashEvents) && raw.cashEvents.length){
      raw.cashEvents.forEach(ev=>{
        if(!ev.date) return;
        events.push({
          date: toDate(ev.date),
          amount: Number(ev.amount||0),
          client: ev.client||"—",
          note: ev.note||"",
          actual: !!ev.actual
        });
      });
    }else{
      // 2) Vastasel juhul sünteesi sündmused arvetest:
      invoices.forEach(inv=>{
        if(inv.paidDate){ // tasutud -> tegelik laekumine tasumise kuupäeval
          events.push({date:inv.paidDate, amount:inv.amount, client:inv.client, actual:true, note:"Tasumine"});
        }else if(inv.dueDate){ // maksmata -> prognoos dueDate kuupäeval
          events.push({date:inv.dueDate, amount:inv.amount, client:inv.client, actual:false, note:"Prognoos"});
        }
      });
    }

    // Sort ja agregeeri sama päeva summad kokku
    const byDay = new Map();
    events.forEach(ev=>{
      const k = +ev.date;
      const cur = byDay.get(k) || {date:ev.date, amount:0, clients:new Set(), actual:true};
      cur.amount += ev.amount;
      cur.clients.add(ev.client);
      cur.actual = cur.actual && ev.actual; // kui ükski on prognoos, muutub prognoosiks
      byDay.set(k, cur);
    });

    // Series: kumulatiivne algsaldoga
    const start = Number(raw.startingBalance||0);
    const rows = [...byDay.values()].sort((a,b)=>a.date-b.date);
    let run = start;
    series = rows.map(r=>{
      run += r.amount;
      return { date: r.date, balance: run, actual: r.actual };
    });

    if(!series.length){
      // kui midagi siiski ei tekkinud, lisa startpunkt
      const today=new Date(); today.setHours(0,0,0,0);
      series = [{date: today, balance: start, actual:true}];
    }
  }

  // Lõika nähtavaks 30/60/90 päeva
  function setRange(r){
    range = r;
    if(!series.length){ visible = []; return; }
    const start = new Date(series[0].date);
    const end   = new Date(start); end.setDate(end.getDate()+r);
    visible = series.filter(pt => pt.date >= start && pt.date <= end);
    refreshKPIs();
    drawChart();
    toast(`Prognoos loodud ${r} päevaks`);
  }

  // KPI-d: madaljääk, riskantsed arved, DSO, säästupotentsiaal
  function refreshKPIs(){
    if(!visible.length){
      $("#kpi-low").textContent = "–";
      $("#kpi-risk").textContent = "–";
      $("#kpi-dso").textContent = "–";
      $("#kpi-savings").textContent = "–";
      $("#chart-note").textContent = "";
      return;
    }
    // madaljääk
    const low = visible.reduce((m,p)=>Math.min(m,p.balance), Infinity);
    $("#kpi-low").textContent = Number.isFinite(low)? `${fmt(low)} €` : "–";
    $("#result-low") && ($("#result-low").textContent = Number.isFinite(low)? `${fmt(low)} €` : "–");
    $("#chart-note").innerHTML = low<0
      ? `Prognoos näitab <span style="color:var(--red);font-weight:600">likviidsusauku ${fmt(low)} €</span>.`
      : `<span style="color:var(--green);font-weight:600">Likviidsusauku ei tuvastatud</span>.`;

    // riskantsed: päevad, kus prognoos langeb alla 0 (mitte-actual)
    const riskDays = visible.filter(p=>!p.actual && p.balance<0).length;
    $("#kpi-risk").textContent = String(riskDays);

    // DSO: keskmine (paidDate - issueDate) tasutud arvetele
    const paid = invoices.filter(i=>i.issueDate && i.paidDate);
    const dso = paid.length ? Math.round(paid.reduce((s,i)=>s+daysBetween(i.issueDate,i.paidDate),0)/paid.length) : null;
    $("#kpi-dso").textContent = dso!=null ? `${dso} p` : "–";

    // säästupotentsiaal: lihtne näide – 2% kõigist maksmata arvetest (receivables)
    const receivables = invoices.filter(i=>!i.paidDate).reduce((s,i)=>s+(i.amount||0),0);
    const savings = Math.round(receivables*0.02);
    $("#kpi-savings").textContent = `${fmt(savings)} €`;
  }

  // What-IF mõjutaja: süvendab ühte madalpunkti (lihtne demo)
  function applyWhatIf(){
    if(!series.length) return;
    const dly = parseInt($("#delay").value||'0',10);
    const disc= parseInt($("#discount").value||'0',10);
    $("#delay-val").textContent = String(dly);
    $("#discount-val").textContent = String(disc);

    // leia seeriast madalaim punkt (ainult prognoositud)
    const idx = series.reduce((best,i,ix,arr)=>{
      if(!i) return best;
      if(arr[best]===undefined) return ix;
      if(i.balance < arr[best].balance && !i.actual) return ix;
      return best;
    }, -1);

    if(idx>=0){
      const factor = 1 + Math.min(.5, dly*.05) - Math.min(.3, disc*.03);
      const delta  = Math.round(series[idx].balance * (factor-1));
      // rakenda delta kõigile sellele päevale ja edasi, et kumulatiivne säiliks
      for(let i=idx;i<series.length;i++){
        series[i] = {...series[i], balance: series[i].balance + delta};
      }
      setRange(range); // uuenda visible & KPI & chart
    }
    toast("Stsenaarium uuendatud");
  }

  // Chart
  function drawChart(){
    const el=$("#chart"); el.innerHTML="";
    if(!visible.length){ return; }
    const w=el.clientWidth||600,h=el.clientHeight||240,p={l:46,r:10,t:10,b:26};
    const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("viewBox",`0 0 ${w} ${h}`); el.appendChild(svg);

    // gradient
    const defs=document.createElementNS(svg.namespaceURI,"defs");
    const grad=document.createElementNS(svg.namespaceURI,"linearGradient");
    grad.setAttribute("id","grad"); grad.setAttribute("x1","0"); grad.setAttribute("y1","0"); grad.setAttribute("x2","0"); grad.setAttribute("y2","1");
    const g1=document.createElementNS(svg.namespaceURI,"stop"); g1.setAttribute("offset","0%"); g1.setAttribute("stop-color","var(--accent)"); g1.setAttribute("stop-opacity","0.30");
    const g2=document.createElementNS(svg.namespaceURI,"stop"); g2.setAttribute("offset","100%"); g2.setAttribute("stop-color","var(--accent)"); g2.setAttribute("stop-opacity","0.02");
    grad.appendChild(g1); grad.appendChild(g2); defs.appendChild(grad); svg.appendChild(defs);

    const xs=visible.map(d=>fDDMM(d.date)), ys=visible.map(d=>d.balance);
    const xstep=(w-p.l-p.r)/Math.max(1,(xs.length-1));
    const ymin=Math.min(0,...ys), ymax=Math.max(...ys), yspan=Math.max(1,ymax-ymin);
    const X=i=>p.l+i*xstep, Y=v=>p.t+(h-p.t-p.b)*(1-(v-ymin)/yspan);

    // telg + harvendus
    const axis=document.createElementNS(svg.namespaceURI,"g"); axis.setAttribute("class","axis");
    const maxTicks=8, step=Math.max(1,Math.ceil(xs.length/maxTicks));
    xs.forEach((lbl,i)=>{
      const tx=X(i);
      // grid
      const gl=document.createElementNS(svg.namespaceURI,"line");
      gl.setAttribute("x1",tx); gl.setAttribute("x2",tx); gl.setAttribute("y1",p.t); gl.setAttribute("y2",h-p.b);
      gl.setAttribute("stroke","var(--border)"); gl.setAttribute("stroke-dasharray","3 3"); axis.appendChild(gl);
      if(i%step===0){
        const t=document.createElementNS(svg.namespaceURI,"text");
        t.setAttribute("x",tx); t.setAttribute("y",h-6); t.setAttribute("text-anchor","middle"); t.textContent=lbl; axis.appendChild(t);
      }
    });
    for(let i=0;i<=4;i++){
      const v=ymin+(yspan/4)*i,ty=Y(v);
      const hl=document.createElementNS(svg.namespaceURI,"line");
      hl.setAttribute("x1",p.l); hl.setAttribute("x2",w-p.r); hl.setAttribute("y1",ty); hl.setAttribute("y2",ty);
      hl.setAttribute("stroke","var(--border)"); hl.setAttribute("stroke-dasharray","3 3"); axis.appendChild(hl);
      const lab=document.createElementNS(svg.namespaceURI,"text");
      lab.setAttribute("x",p.l-8); lab.setAttribute("y",ty+4); lab.setAttribute("text-anchor","end"); lab.textContent=fmt(v); axis.appendChild(lab);
    }
    svg.appendChild(axis);

    // ala
    if(xs.length){
      let dpath=""; visible.forEach((pt,i)=>{const px=X(i),py=Y(pt.balance); dpath+=(i===0?`M ${px} ${py}`:` L ${px} ${py}`)});
      const y0=Y(0); dpath+=` L ${X(xs.length-1)} ${y0} L ${X(0)} ${y0} Z`;
      const area=document.createElementNS(svg.namespaceURI,"path"); area.setAttribute("d",dpath); area.setAttribute("class","area"); svg.appendChild(area);
      const zero=document.createElementNS(svg.namespaceURI,"line"); zero.setAttribute("x1",p.l); zero.setAttribute("x2",w-p.r); zero.setAttribute("y1",y0); zero.setAttribute("y2",y0); zero.setAttribute("class","zero"); svg.appendChild(zero);
    }
  }

  // CSV eksport: kuupäev, kumulatiiv, märkus (Tegelik/Prognoos)
  $("#exportBtn").onclick=()=>{
    if(!series.length){ toast("Pole midagi eksportida"); return; }
    const rows=[["Kuupäev","Kumulatiivne jääk (€)","Märkus"]];
    series.forEach(p=>{
      rows.push([fDDMM(p.date), String(p.balance), p.actual?"Tegelik":"Prognoos"]);
    });
    const csv=rows.map(cols=>cols.map(c=>{const s=String(c);return /[;"\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s}).join(";")).join("\n");
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8"}));
    a.download=`finsight_${new Date().toISOString().slice(0,10)}_${range}p.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    toast("CSV eksporditud");
  };

  // Nupud
  $("#createBtn").onclick=()=>{ const r=parseInt($("#horizon").value,10); setRange(r); };
  $("#rerun")?.addEventListener('click',applyWhatIf);
  $("#delay")?.addEventListener('input',e=>$("#delay-val").textContent=e.target.value);
  $("#discount")?.addEventListener('input',e=>$("#discount-val").textContent=e.target.value);
  window.addEventListener('resize',drawChart);

  // INIT
  (async function init(){
    await loadData();
    buildEventsFromRaw();
    setRange(30); // vaikimisi 30p
    // Alerts demo
    const alerts=[
      {type:"critical",title:"Likviidsusauk prognoosis",detail:"Jääk langeb alla 0 valitud horisondis."},
      {type:"info",title:"Paku ettemakse soodustust",detail:"Hilinenud klientidele 2% soodustus võib kiirendada."},
      {type:"warn",title:"Ajasta väljaminek hilisemaks",detail:"Lükka tarnija makse 7p, et vältida miinust."}
    ];
    const el=$("#alerts");
    el.innerHTML="";
    alerts.forEach(a=>{
      const tone=a.type==="critical"?"#fecaca":(a.type==="warn"?"#fde68a":"#bbf7d0");
      const card=document.createElement('div');
      card.style.cssText=`border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px;background:${tone}20`;
      card.innerHTML=`<div style="font-weight:600">${a.title}</div><div class="muted" style="font-size:13px">${a.detail}</div>`;
      el.appendChild(card);
    });
  })();
</script>
</body>
</html>
